#include "mainconfig.h"
#include "mygpio.h"
#include "myiwdg.h"
#include "ssec.h"
#include "mysettings.h"
#include "playsound.h"
#include "buttonpush.h"
#include "lockproc.h"
#include "manualkey.h"

// Связь между проигрывающей и записывающей частями
// 
uint32_t curkey;
uint32_t curmask;

int16_t push[MAXIMPULS];  // Времена импульсов
//extern int16_t pnum;    // Число импульсов в массиве // задается в buttonpush

void SetPass(uint32_t mask, uint32_t key){  // запись пароля в в память 
	  DSt.currentkey=key;
	  DSt.currentmask=mask;
		hssavetime=getssec();
}

void CheckPass(uint32_t mask, uint32_t key){ // 
	if(mask == DSt.currentmask && key == DSt.currentkey){
		DoorCmd(0);
	}

}
void Analize(int16_t massToAnalize[], int16_t size){
				  int16_t max = massToAnalize[0];
				  int16_t min = massToAnalize[0];
	        int16_t averageValue;
	        uint32_t mask = 0;
	        uint32_t key = 0;
	
          if(size == 1){
						if (massToAnalize[0] >=80){
							DoorCmd(1);
							return;
						}
					}
          // 	equalValues - флаг разности значений
	        //  0 - Считаем, что элементы в массиве разные
	        //  1 - Считаем, что элементы в массиве одинаковые
	        int16_t equalValues = 0;
				
				  for(int i = 2; i<size; i+=2){             // находим максимальны и минимальный элемент массива
						if (massToAnalize[i] < min){
							min = massToAnalize[i];
						}
						if (massToAnalize[i] > max){
							max = massToAnalize[i];
						}
					}
					averageValue = (max - min)/2;
					if (__fabs(1-(min/max))<=0.1){
						equalValues = 1;
					}
					 
					if (equalValues == 0){
						for(int i = 0; i<size; i+=2){
							mask <<= 1;
							if(massToAnalize[i] <= averageValue){
								key |= 0;
							}
							else{
								key |= 1;
							}
						}
					}
					else{
						for(int i = 0; i<size; i+=2){
							mask <<= 1;
							key |= 1;
						}
					}
					
					if(!GGetPin(PROGSW)){
						SetPass(mask, key);
					}
					else{
						CheckPass(mask, key);
					}
}



void SysInit(void) {
  RCC->CR |= 0x00000001;     // ???????? HSI
  while (!(RCC->CR&0x02));  // ??????? HSI (?? ?????? ??????)
// ???????? ?? ??????
  RCC->CR &= 0x0000FFF8;
  RCC->CFGR=0;  // ????????? ?? HSI ? ??? ???????????? - ?? ????
// ????????? PLL - ???????? ????? ?? 16 ???
  RCC->CFGR2=1;  // ? ??? ????? ???????????? ????? PLL
  RCC->CFGR3=0;
  RCC->CFGR|=0x00080000;  // ????? ?? 2, ???????? ?? 4, ???????? - HSI
  RCC->CR |= 0x01000000;  // ????????? PLL
  while (!RCC->CR&0x02000000);        // ??????? ????????? PLL. ???? ?? ????????? - ?????????? ?????? ??? ????????
  FLASH->ACR = 0x00000010;  // Enable Prefetch Buffer and set Flash Latency
  RCC->CFGR|=0x00000002;    // ???????? PLL ??? ???????? ????????????
  while (!((RCC->CFGR&0x0C)==(0x02<<2)));  // ??????? ?????????????
// 
  RCC->CIR = 0x00000000;    // ????????? ??? ??????????
}

void ConfigHW() {
// ??????? ?????????? ? ???? ??? ?????, ????? ??? ????? ????????????
  RCC->AHBENR|=RCC_AHBENR_GPIOAEN|RCC_AHBENR_GPIOBEN|RCC_AHBENR_GPIOCEN|RCC_AHBENR_GPIODEN|RCC_AHBENR_GPIOFEN;
  RCC->APB1ENR|=RCC_APB1ENR_TIM3EN;     // ?????? ?????????? ????????? ??????????? 1?? ? ???????????? - ???????? UART
  RCC->APB2ENR|=RCC_APB2ENR_SYSCFGCOMPEN;// ????????? ??????? (???? ??? ???????? ?? ?????)
// ?????? ??????????? ??????  
// ??????
// 
// ??????
  GSetPinToOutput(RELAYOPEN,0,0);
  GSetPinToOutput(RELAYCLOSE,0,0);  
  GSetPinToOutput(MAINLED,1,0);
  GSetPinToOutput(SOUND,0,0);
// ?????
  GSetPinToInput(KEYOPEN,GPIO_PULLUP);
  GSetPinToInput(KEYCLOSE,GPIO_PULLUP);
  GSetPinToInput(PROGSW,GPIO_PULLUP);
  GSetPinToInput(BUTTON,0);
// ?? ???????????? ??????
  GSetPinToInput(GPIOA,0,GPIO_PULLDOWN);
  GSetPinToInput(GPIOA,1,GPIO_PULLDOWN);
  GSetPinToInput(GPIOA,2,GPIO_PULLDOWN);
  GSetPinToInput(GPIOA,3,GPIO_PULLDOWN);
  GSetPinToInput(GPIOA,4,GPIO_PULLDOWN);
  GSetPinToInput(GPIOA,5,GPIO_PULLDOWN);
  GSetPinToInput(GPIOA,11,GPIO_PULLDOWN);
  GSetPinToInput(GPIOA,12,GPIO_PULLDOWN);
  GSetPinToInput(GPIOB,5,GPIO_PULLDOWN);
  GSetPinToInput(GPIOB,7,GPIO_PULLDOWN);
// ?????? ????????? SSEC
  InitSSEC();
  __enable_irq();
}

////////////////////////////////////////////////////////////
int main() {	
////////////////////////////////////////////////////
  SysInit();   // ????????? ?????????? ?? ?????? ??? ??????? (?????? - 16???)
#ifndef MYDEBUG
  InitIWDG(4);
#endif
  ConfigHW();  // ????????????? ?????????? ????? ??????????? (??????)
  ReinitFromHardDSt(0);
  while (hssavetime!=0) {
    CLRWDT();
    CheckSaveHardDSt();
  }
  for (;;) {  
    CheckSaveHardDSt();
    if (buttonpush()) {
// Пришел массив. Надо анализировать (Пока проигрываем)
			 Analize(push, pnum1);
			 
	//		mask<<=1; // 
	//		mask|=1;  // Добавляешь единичку
			
			
		
			//StartSound();
			
			/*
			  DSt.currentkey=0xABCDEF;
		  	hssavetime=getssec();
			*/
			
			
    }
    beep();
		opendoor();
		manualkey();
  }

}
